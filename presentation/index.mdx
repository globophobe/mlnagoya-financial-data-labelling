import { Layout, Image, Appear, Fit, Fill, Heading, Link, Table, TableHeader, TableHeaderItem, TableBody, TableRow, TableItem } from 'spectacle';
import { DarkSlide, CodeSlide } from './slides';
import arex from '../assets/arex.jpg';
import cover from '../assets/cover.jpg';
import coverJapanese from '../assets/cover-japanese.jpg';
import marcos from '../assets/marcos.jpg';
import bitcoin from '../assets/bitcoin.png';
import fixedHorizon from '../assets/fixed-horizon.png';
import tripleBarrier from '../assets/triple-barrier.png';
import cusum from '../assets/cusum.png';
import volatility from '../assets/volatility.png';
import buySide from '../assets/buy-side.png';
import sellSide from '../assets/sell-side.png';
import tripleBarrierBinary from '../assets/triple-barrier-binary.png';

<Heading style={{ marginBottom: 0 }}>
  Labelling Financial Data
  <br />
  <span style={{ fontSize: "8.5vmin" }}>
    財務データのラベル付け
  </span>
</Heading> 
<Appear>
  <Heading size={2} style={{ color: "#737373" }}>
    with bonus Amazon Forecast.
  </Heading> 
</Appear>

---

# These slides are at Connpass. So you can check them out.
## スライドはConnpassにアップされています。 是非みてください。

---

# Who am I?
## お前誰?

---

# My name is Alex, and I'm from Canada 🇨🇦
## アレックスで、カナダから来ました。

---

<Layout>
  <Fill style={{ margin: "auto" }}>
    <Heading>My username on Connpass is "globophobe".</Heading>
    <Heading size={4}>Connpassのユーザ名は「globophobe」です。</Heading>
  </Fill>
  <Fill>
    <Image style={{ borderRadius: "35px", marginLeft: "35px" }} src={arex} />
  </Fill>
</Layout>

---

# I make stuff with Python, Django, Vue.js and React Native. 
## PythonやDjangoやVue.jsやReact Nativeでプログラミングしています。

---

# This is just for fun.
## これはただの楽しみです。

---

<Layout>
  <Fill style={{ margin: "auto" }}>
    <Heading>Recently, I have been reading this book.</Heading>
    <Heading size={2}>
      最近この本を読んでいます。
    </Heading>
  </Fill>
  <Fill>
      <Link href="https://www.amazon.co.jp/Advances-Financial-Machine-Learning-Marcos/dp/1119482089/">
      <Image style={{ height: "96vh", borderRadius: "10px", marginLeft: "auto", marginRight: "auto" }} src={cover} />
    </Link>
  </Fill>
</Layout>

---

<Layout>
  <Fill style={{ margin: "auto" }}>
    <Heading>Currently, it is published in Japanese.</Heading>
    <Heading size={2}>現在日本語で出版されています。</Heading>
  </Fill>
  <Fill>
      <Link href="https://www.amazon.co.jp/%E3%83%95%E3%82%A1%E3%82%A4%E3%83%8A%E3%83%B3%E3%82%B9%E6%A9%9F%E6%A2%B0%E5%AD%A6%E7%BF%92-%E3%83%9E%E3%83%AB%E3%82%B3%E3%82%B9%E3%83%BB%E3%83%AD%E3%83%9A%E3%82%B9%E3%83%BB%E3%83%87%E3%83%BB%E3%83%97%E3%83%A9%E3%83%89/dp/4322134637/">
      <Image style={{ height: "96vh", borderRadius: "10px", marginLeft: "auto", marginRight: "auto" }} src={coverJapanese} />
    </Link>
  </Fill>
</Layout>

---

<Layout>
  <Fill style={{ margin: "auto" }}>
    <Heading size={4}>
      The author Marcos Lopez de Prado was named <Link href="https://jpm.pm-research.com/quant-of-2019">Quant of 2019</Link> by the <Link href="https://jpm.pm-research.com/">Journal of Portfolio Management</Link>
    </Heading>
    <Heading size={5}>著者は、JPMにより「クォント オブ ザ イヤー」に選ばれました。</Heading>
  </Fill>
  <Fill>
    <Image style={{ height: "80vh", borderRadius: "35px", marginLeft: "35px" }} src={marcos} />
  </Fill>
</Layout>

---

# According to the author, "One day in the near future, ML will dominate finance...
## 著者によると、「近い将来、MLが金融を支配して...

---

# ...science will curtail guessing, and investing will not mean gambling."
## 科学は推測を削減し、そしてその近く将来には、投資をする事はもうギャンブルの意味もしません。」

---

# In Chapter 2, volume clock sampling was discussed.
## 第2章では財務データ構造について

---

# In a <Link href="https://twitter.com/JacquesQuant/status/1210309445202436100">question</Link> on Twitter, a lead developer of the <Link href="https://github.com/hudson-and-thames/mlfinlab">MLFinLab</Link> package...

---

# ...which implements Lopez de Prado's research... 

---

# ...asks about the importance of volume clock sampling.

---

# Lopez de Prado answered, "I would use volume clock whenever possible...

---

# ...even if the analysis also appears to work with chronological time."

---

# Unfortunately, raw transaction data is necessary for volume clock sampling.
## 生の取引データは、ティック、ボリューム、またはドルベースのバーを作成するために必要です。

---

# Usually, such data is very expensive.
## 通常、そのようなデータは非常に高価です。

---

<Layout>
  <Fill style={{ margin: "auto" }}>
    <Heading>
      However, it is provided free by some Bitcoin exchanges.
    </Heading>
    <Heading size={3}>
      しかし、ビットコインの取引所では無料で提供されています。
    </Heading>
  </Fill>
  <Fill>
    <Image style={{ borderRadius: "35px", marginTop: "50%", marginBottom: "50%", marginLeft: "35px" }} src={bitcoin} />
  </Fill>
</Layout>

---

# My preference is data for the Bitmex XBTUSD perpetual future contract.
## 私はBitmexのXBTUSDの永続的な先物契約のデータにしました。

---

# In Chapter 3, labelling financial data is discussed.
## 第3章では財務データ構造について

---

# Most quantitative methods use fixed time horizon labeling methods.
## ほとんどの定量的方法は、固定時間範囲ラベル付け方法を使用します。 

---

# The label is determined when price touches the vertical barrier.
## ラベルは、価格が垂直障壁にタッチすると決定されます。

---

<Image style={{ height: "80vh" }} src={fixedHorizon} />

---

# Lopez de Prado identifies two problems with such labels.
# そのようなラベルに関する2つの問題あります。
---

# 1) Time-horizon is fixed, but volatility is not.
## 期間が固定されていますが、ボラティリティは固定されていません。

---

# 2) The realities of trading require both stop loss and take profit thresholds.
## 取引の現実には、ストップロスと利益の閾値の両方が必要です。

---

# Lopez de Prado describes a "triple-barrier" labelling method.
## Lopez de Pradoは「トリプルバリア」ラベル付けて言う事について説明します。

---

<Image style={{ height: "80vh" }} src={tripleBarrier} />

---

# The vertical barrier is the same as fixed-horizon labelling.
## 水平バリアは、固定水平ラベル付けと同じです。

---

# The upper and lower barriers are take profit or stop loss thresholds.
## 上限と下限の障壁は、利潤またはストップロスのしきい値です。

---

# Lopez de Prado recommends calculating the upper and lower barriers with a point estimation of volatility... 
## ボラティリティのポイント推定を計算して、そしてそのポイント推定を使って上バリアと下バリアの障壁を計算する事が勧められています。

---

# ...which is the mean of the exponentially weighted moving standard deviation of returns.
## ...そのポイント推定はリターンの指数加重移動標準偏差の平均です。

---

# Returns being defined as the percent change in price between time T and T - 1.
## 戻り値は時間TとT-1の間の価格の変化率として定義されています。

---

# As per the following function:
## 次の関数で計算します：

---

export default CodeSlide

```python
def get_volatility(prices, span=100, delta=pd.Timedelta(hours=24)):
    df = prices.index.searchsorted(prices.index - delta)
    df = df[df > 0]
    df = pd.Series(prices.index[df - 1], 
                   index=prices.index[prices.shape[0]-df.shape[0]:])
    df = prices.loc[df.index] / prices.loc[df.values].values - 1
    df = df.ewm(span=span).std()
    return df
}
```

---

#### The exponentially weighted moving standard deviation of returns:
#### リターンの指数加重移動標準偏差：

<Image style={{ height: "65vmin" }} src={volatility} />

---

# The mean of which becomes the threshold for the following function:
## その平均が次の関数のしきい値になります。

---

export default CodeSlide

```python
def cusum_filter(prices, threshold):
    events, pos, neg = [], 0, 0
    diff = prices.diff()
    for idx in diff.index[1:]:
        pos = max(0, pos + diff.loc[idx])
        neg = min(0, neg + diff.loc[idx])
        if neg < -threshold:
            neg = 0; events.append(idx)
        elif pos > threshold:
            pos = 0; events.append(idx)
    return pd.DatetimeIndex(events)
```

---

# The *cusum_filter* reduces the price series to only data points greater or less than the threshold.
## *cusum_filter* は、価格系列をしきい値よりも大きいまたは小さいポイントのみに減らします。

---

# An example of the *cusum_filter* :
## *cusum_filter* の例：

<Image style={{ height: "60vh" }} src={cusum} />

---

# The *cusum_filter* is described as an "[improvement] over popular market signals such as Bollinger bands. More on this later.
## * cusum_filter *は人気のある市場信号「ボリンジャーバンド」とかに対する[改善]として説明されています。これについては後で詳しく説明します。
---

# The time of the first touch, to either upper, lower, or vertical barrier is calculated. 
## 上部、下部、または垂直バリアへの最初のタッチの時間が計算されます。

---

## These are some "triple-barrier" touches.
<Heading size={2} style={{ marginBottom: "0.5em" }}>「トリプルバリア」タッチです。</Heading>

<Table>
  <TableHeader>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>timestamp</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>target</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>touch</TableHeaderItem>
  </TableHeader>
  <TableBody>
    <TableRow>
      <TableItem style={{ fontSize: "4.5vmin" }}>2017-03-22 13:58:33.411609</TableItem>
      <TableItem style={{ fontSize: "4.5vmin" }}>0.0662078</TableItem>
      <TableItem style={{ fontSize: "4.5vmin" }}>2017-03-23 14:14:25.540570</TableItem>
    </TableRow>
    <TableRow>
      <TableItem style={{ fontSize: "4.5vmin" }}>2017-07-21 02:25:36.397497</TableItem>
      <TableItem style={{ fontSize: "4.5vmin" }}>0.0168957</TableItem>
      <TableItem style={{ fontSize: "4.5vmin" }}>2017-07-21 03:04:44.531031</TableItem>
    </TableRow>
    <TableRow>
      <TableItem style={{ fontSize: "4.5vmin" }}>2018-12-17 12:12:43.155227</TableItem>
      <TableItem style={{ fontSize: "4.5vmin" }}>0.0141053</TableItem>
      <TableItem style={{ fontSize: "4.5vmin" }}>2018-12-17 12:12:57.062203</TableItem>
    </TableRow>
  </TableBody>
</Table>

---

## The touches are indexed with the original dataframe to become labels.
## タッチは元のデータフレームでインデックス付けされ、ラベルになります。

<Table>
  <TableHeader>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>timestamp</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>target</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>return</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>label</TableHeaderItem>
  </TableHeader>
  <TableBody>
    <TableRow>
      <TableItem style={{ fontSize: "5vmin" }}>2017-03-22 13:58:33.411609</TableItem>
      <TableItem style={{ fontSize: "5vmin" }}>0.066208</TableItem>
      <TableItem style={{ fontSize: "5vmin" }}>0.019608</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}><strong>0</strong></TableItem>
    </TableRow>
    <TableRow>
      <TableItem style={{ fontSize: "5vmin" }}>2017-07-21 02:25:36.397497</TableItem>
      <TableItem style={{ fontSize: "5vmin" }}>0.016896</TableItem>
      <TableItem style={{ fontSize: "5vmin" }}>-0.018248</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}><strong>-1</strong></TableItem>
    </TableRow>
    <TableRow>
      <TableItem style={{ fontSize: "5vmin" }}>2018-12-17 12:12:43.155227</TableItem>
      <TableItem style={{ fontSize: "5vmin" }}>0.014105</TableItem>
      <TableItem style={{ fontSize: "5vmin" }}>0.015244</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}><strong>1</strong></TableItem>
    </TableRow>
  </TableBody>
</Table>

---

## *Label 0* return was less than target when the vertical barrier, the max-holding period, was touched.
## *ラベル 0 * 最大保有期間である垂直障壁に触れたときのリターンは目標を下回っていました。

<Table>
  <TableHeader>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>timestamp</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>target</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>return</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>label</TableHeaderItem>
  </TableHeader>
  <TableBody>
    <TableRow>
      <TableItem style={{ fontSize: "5.5vmin" }}>2017-03-22 13:58:33.411609</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}>0.066208</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}>0.019608</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}><strong>0</strong></TableItem>
    </TableRow>
  </TableBody>
</Table>

---

## *Label -1* return was negative when the lower barrier, stop-loss, was touched.
## *ラベル -1 * 下の障壁であるストップロスに触れた時のリターンは負でした。

<Table>
  <TableHeader>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>timestamp</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>target</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>return</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>label</TableHeaderItem>
  </TableHeader>
  <TableBody>
    <TableRow>
      <TableItem style={{ fontSize: "5.5vmin" }}>2017-07-21 02:25:36.397497</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}>0.016896</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}>-0.018248</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}><strong>-1</strong></TableItem>
    </TableRow>
  </TableBody>
</Table>

---

## *Label 1* return was greater than target when the upper barrier, take-profit, was touched.
## *ラベル 1 * 利益が上位障壁であるテイクプロフィットに触れたときのリターンは目標を上回りました。

<Table>
  <TableHeader>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>timestamp</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>target</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>return</TableHeaderItem>
    <TableHeaderItem style={{ fontSize: "6vmin" }}>label</TableHeaderItem>
  </TableHeader>
  <TableBody>
    <TableRow>
      <TableItem style={{ fontSize: "5.5vmin" }}>2018-12-17 12:12:43.155227</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}>0.014105</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}>0.015244</TableItem>
      <TableItem style={{ fontSize: "5.5vmin" }}><strong>1</strong></TableItem>
    </TableRow>
  </TableBody>
</Table>

---

# Labels of either 1 or -1 indicate a trading opportunity.
1または-1のラベルは、取引の機会を示します。

---

# *Label 1*, buy low and sell high.
## *ラベル 1*、安値で購入、高値で販売。

<Image style={{ height: "60vh" }} src={buySide} />

---

# *Label -1*, sell high and buy low.
## *ラベル -1*、高値で売り、低値で買います。

<Image style={{ height: "60vh" }} src={sellSide} />

---

# *Label -1*, implies margin trading. Selling that which you do not have.
## *ラベル -1*、証拠金取引を意味します。 持っていないものを売る。

---

# Example, using ¥100,000 as margin (collateral) to sell ¥1,000,000.
## たとえば、100,000円をマージン（担保）として使用して、1,000,000円を販売します。

---

# *Label 0*, suggests not enough volatility for trading to be worthwhile.
## *ラベル 0*、 取引に値するボラティリティが十分でない事を示しています。

---

# Lopez de Prado also describes "meta-labelling".
## 「メタラベル」て言う事はも説明しれています。

---

# Basically, the outcomes of the primary model become input for a secondary model.
## 基本的に、プライマリモデルの結果は、セカンダリモデルの入力になります。

---

# The secondary model learns position size only, not whether to trade or not.
## セカンダリモデルはポジションサイズのみを学習し、取引するかどうかは学習しません。 

---

# Lopez de Prado suggests "meta-labelling" can be particulary useful...
## 「メタラベル」が特に有用のは...

---

# ...when outcomes are asymmetric, because it can help avoid large drawdowns (losses).
## ...結果は非対称時です。大きいな損失を回避する事を助けるんからです。

---

# The primary model should have high recall, more true positives, and as few false positives as possible. 
## プライマリモデルは、高い再現率しべきで、多くの真の陽性ようで、出来るだけ誤検知がすくないようです。

---

# The secondary model filters the false positives from the primary model.
## セカンダリモデルは、プライマリモデルからの誤検出をフィルタリングします。

---

# In a recent <Link href="https://time.com/5751190/investing-machine-learning-marcos-de-lopez-prado/">article in Time magazine</Link>, Lopez de Prado states...

---

# ...ML should be used as a research tool, and not as a forecasting tool.

---

# This precludes using Amazon Forecast.
##

---

# However, let's try anyway.
##

---

# That’s all. Thanks for listening.
## 以上です。ご清聴ありがとうございます。
